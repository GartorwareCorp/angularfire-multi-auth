angular.module("angularfire-multi-auth",["firebase"]),function(){"use strict";angular.module("angularfire-multi-auth").config(["$provide",function(a){a.decorator("$firebaseAuth",["$delegate","$q","$window","FBURL_ALTERNATE",function(a,b,c,d){var e=a;return a=function(f){function g(){u=new p(f),t=e(f),v={$createUser:t.$createUser,$removeUser:t.$removeUser,$authWithPassword:t.$authWithPassword,$authWithOAuthPopup:t.$authWithOAuthPopup,$authAnonymously:t.$authAnonymously},t.$createUser=h,t.$removeUser=i,t.$authWithPassword=j,t.$authWithOAuthPopup=k,t.$authAnonymously=l,t.$associateSocial=m,t.$disassociateSocial=n,t.$associatePassword=o}function h(a){var c=b.defer();return v.$createUser(a).then(function(b){v.$authWithPassword(a).then(function(a){q(a,function(){t.$unauth(),c.resolve(b)})})["catch"](function(a){c.reject(a)})})["catch"](function(a){c.reject(a)}),c.promise}function i(a){var c=b.defer();return v.$authWithPassword(a).then(function(b){var d=new Firebase(f.root()+"/authGroup");d.orderByChild(b.provider).equalTo(b.uid).on("child_added",function(b){b.ref().remove(function(b){b?c.reject(b):(t.$unauth(),v.$removeUser(a).then(function(){c.resolve()})["catch"](function(a){c.reject(a)}))})})})["catch"](function(a){c.reject(a)}),c.promise}function j(a,c){var d=b.defer();return v.$authWithPassword(a,c).then(function(a){r(a,d)})["catch"](function(a){d.reject(a)}),d.promise}function k(a,c){var d=b.defer();return v.$authWithOAuthPopup(a,c).then(function(a){r(a,d)})["catch"](function(a){d.reject(a)}),d.promise}function l(a){var c=b.defer(),d=t.$getAuth();if(d){var e=new Firebase(f.root()+"/authGroup/"+d.authGroup);e.orderByKey().equalTo("anonymous").once("value",function(b){var e=null!==b.val();"anonymous"===d.provider||e?c.resolve(d):s(a,c)})}else s(a,c);return c.promise}function m(c){var e=b.defer(),g=new Firebase(d),h=a(g),i=t.$getAuth(),j=new Firebase(f.root()+"/authGroup/"+i.authGroup);return j.orderByKey().equalTo(c).once("value",function(a){c===i.provider||null!==a.val()?e.reject("You are already using a "+c+" account."):h.$authWithOAuthPopup(c).then(function(a){var b=new Firebase(f.root()+"/userMapping/"+a.uid);b.once("value",function(b){var c=null!==b.val();if(c)e.reject("You are already associated to another account");else{var d=new Firebase(f.root()+"/authGroup/"+i.authGroup),g={};g[a.provider]=a.uid,d.update(g,function(){var b=new Firebase(f.root()+"/userMapping"),c={};c[a.uid]=i.authGroup,b.update(c,function(){h.$unauth(),e.resolve(a)})})}})})["catch"](function(a){e.reject(a)})}),e.promise}function n(a,c){var d=b.defer(),e=t.$getAuth();if(a===e.uid)d.reject("The account you want to disassociate is the logged on user, please logoff and login with another account");else{var g=new Firebase(f.root()+"/userMapping/"+a);g.remove(function(a){if(a)d.reject(a);else{var b=new Firebase(f.root()+"/authGroup/"+e.authGroup+"/"+c);b.remove(function(a){a?d.reject(a):d.resolve()})}})}return d.promise}function o(a){var c=b.defer(),d=t.$getAuth(),e=new Firebase(f.root()+"/authGroup/"+d.authGroup);return e.orderByKey().equalTo("password").once("value",function(b){var e=null!==b.val();"password"===d.provider||e?c.reject("You are already  using a password account."):v.$createUser(a).then(function(b){var e=new Firebase(f.root()+"/userMapping/"+b.uid);e.once("value",function(e){var g=null!==e.val();if(g)c.reject("the email is already associated with another account");else{var h=new Firebase(f.root()+"/users/"+d.authGroup);h.update({email:a.email});var i=new Firebase(f.root()+"/authGroup/"+d.authGroup),j={};j.password=b.uid,i.update(j,function(){var a=new Firebase(f.root()+"/userMapping"),e={};e[b.uid]=d.authGroup,a.update(e,function(){c.resolve(b)})})}})})["catch"](function(a){c.reject(a)})}),c.promise}function p(a){function b(){return JSON.parse(c.localStorage.getItem(h))}function d(a){c.localStorage.setItem(h,JSON.stringify(a))}function e(a){var b;return b=a.indexOf("://")>-1?a.split("/")[2]:a.split("/")[0],b=b.split(":")[0]}function f(a){return a.split(".firebaseio.com")[0]}var g=f(e(a.root().toString())),h="firebase:session::"+g,i={get:b,set:d};return i}function q(a,b){var c=new Firebase(f.root()+"/authGroup"),d={};d[a.provider]=a.uid;var e=c.push(d,function(){var c=new Firebase(f.root()+"/userMapping"),d={};d[a.uid]=e.key(),c.update(d,b(e))});return a}function r(a,b){var c=u.get(),d=new Firebase(f.root()+"/userMapping/"+a.uid);d.once("value",function(d){var e=null!==d.val();return e?(c.authGroup=d.val(),a.authGroup=d.val(),u.set(c),b.resolve(a)):q(a,function(d){c.authGroup=d.key(),a.authGroup=d.key(),u.set(c),b.resolve(a)}),a})}function s(a,b){v.$authAnonymously(a).then(function(a){r(a,b)})["catch"](function(a){b.reject(a)})}var t,u,v;return g(),t}}])}])}();